#include <string.h>
#include <wonderful.h>
#include <ws.h>
#include "chip8.h"

static const uint8_t __wf_rom chip8_font[] = {
    0xF0, 0x90, 0x90, 0x90, 0xF0, // 0
    0x20, 0x60, 0x20, 0x20, 0x70, // 1
    0xF0, 0x10, 0xF0, 0x80, 0xF0, // 2
    0xF0, 0x10, 0xF0, 0x10, 0xF0, // 3
    0x90, 0x90, 0xF0, 0x10, 0x10, // 4
    0xF0, 0x80, 0xF0, 0x10, 0xF0, // 5
    0xF0, 0x80, 0xF0, 0x90, 0xF0, // 6
    0xF0, 0x10, 0x20, 0x40, 0x40, // 7
    0xF0, 0x90, 0xF0, 0x90, 0xF0, // 8
    0xF0, 0x90, 0xF0, 0x10, 0xF0, // 9
    0xF0, 0x90, 0xF0, 0x90, 0x90, // A
    0xE0, 0x90, 0xE0, 0x90, 0xE0, // B
    0xF0, 0x80, 0x80, 0x80, 0xF0, // C
    0xE0, 0x90, 0x90, 0x90, 0xE0, // D
    0xF0, 0x80, 0xF0, 0x80, 0xF0, // E
    0xF0, 0x80, 0xF0, 0x80, 0x80  // F
};

__attribute__((aligned(2)))
chip8_state_t chip8_state;

void chip8_init(void) {
    uint16_t old_rand = chip8_state.rand;
    memset(&chip8_state, 0, sizeof(chip8_state_t));
    chip8_state.lkey = 0xFF;
    chip8_state.pc = 0x0200;
    chip8_state.rand = old_rand;

    memset(CHIP8_RAM, 0, 0x1000);
    memcpy(CHIP8_RAM + CHIP8_RAM_FONT_OFFSET, chip8_font, sizeof(chip8_font));
    chip8_clear_display();
}
